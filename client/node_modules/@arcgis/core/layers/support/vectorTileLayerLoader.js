/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import"../../geometry.js";import e from"../../request.js";import{clone as t}from"../../core/lang.js";import{throwIfAborted as r}from"../../core/promiseUtils.js";import{isProtocolRelative as o,isAbsolute as s,join as l,removeTrailingSlash as n,normalize as i,removeFile as u,getAppBaseUrl as a,addQueryParameters as c}from"../../core/urlUtils.js";import{WGS84 as f,WebMercator as m}from"../../geometry/support/spatialReferenceUtils.js";import{geographicToWebMercator as p}from"../../geometry/support/webMercatorUtils.js";import y from"./TileInfo.js";import d from"../../views/2d/engine/vectorTiles/style/VectorTileSource.js";import x from"../../views/2d/tiling/TileInfoView.js";import S from"../../geometry/SpatialReference.js";async function w(e,t){const r={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[o,s]="string"==typeof e?[e,null]:[null,e.jsonUrl];await j(r,"esri",e,s,t);return{layerDefinition:r.validatedSource,url:o,serviceUrl:r.sourceUrl,style:r.style,styleUrl:r.styleUrl,spriteUrl:r.style.sprite&&h(r.styleBase,r.style.sprite),spriteFormat:r.spriteFormat,glyphsUrl:r.style.glyphs&&h(r.styleBase,r.style.glyphs),sourceNameToSource:r.sourceNameToSource,primarySourceName:r.primarySourceName}}function h(...e){let t;for(const r of e)if(null!=r)if(o(r)){if(t){const e=t.split("://")[0];t=e+":"+r.trim()}}else t=s(r)?r:l(t,r);return t?n(t):void 0}async function j(t,o,s,l,n){let u,a,c;if(r(n),"string"==typeof s){const t=i(s);c=await e(t,{...n,responseType:"json",query:{f:"json",...n?.query}}),c.ssl&&(u&&(u=u.replace(/^http:/i,"https:")),a&&(a=a.replace(/^http:/i,"https:"))),u=t,a=t}else null!=s&&(c={data:s},u=s.jsonUrl||null,a=l);const f=c?.data;if(U(f))return t.styleUrl=u||null,N(t,f,a,n);if(v(f))return t.sourceUrl?I(t,f,a,!1,o,n):(t.sourceUrl=u||null,I(t,f,a,!0,o,n));throw new Error("You must specify the URL or the JSON for a service or for a style.")}function g(e){return"object"==typeof e&&!!e&&"tilejson"in e&&null!=e.tilejson}function U(e){return!!e&&"sources"in e&&!!e.sources}function v(e){return!U(e)}async function N(e,t,r,o){const s=r?u(r):a();e.styleBase=s,e.style=t,t["sprite-format"]&&"webp"===t["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const l=[];if(t.sources&&t.sources.esri){const r=t.sources.esri;r.url?await j(e,"esri",h(s,r.url),void 0,o):l.push(j(e,"esri",r,s,o))}for(const n of Object.keys(t.sources))"esri"!==n&&"vector"===t.sources[n].type&&(t.sources[n].url?l.push(j(e,n,h(s,t.sources[n].url),void 0,o)):t.sources[n].tiles&&l.push(j(e,n,t.sources[n],s,o)));await Promise.all(l)}async function I(e,t,r,o,s,l){const i=r?n(r)+"/":a(),u=T(t),f=new d(s,c(i,l?.query??{}),u);if(!o&&e.primarySourceName in e.sourceNameToSource){const t=e.sourceNameToSource[e.primarySourceName];if(!t.isCompatibleWith(f))return;null!=f.fullExtent&&(null!=t.fullExtent?t.fullExtent.union(f.fullExtent):t.fullExtent=f.fullExtent.clone()),t.tileInfo&&f.tileInfo&&t.tileInfo.lods.length<f.tileInfo.lods.length&&(t.tileInfo=f.tileInfo)}if(o&&(e.sourceBase=i,e.source=t,e.validatedSource=u,e.primarySourceName=s),e.sourceNameToSource[s]=f,!g(e)&&"defaultStyles"in t&&!e.style){if(null==t.defaultStyles)throw new Error;return"string"==typeof t.defaultStyles?j(e,"",h(i,t.defaultStyles,"root.json"),void 0,l):j(e,"",t.defaultStyles,h(i,"root.json"),l)}}function T(e){if(e.hasOwnProperty("tileInfo"))return e;const r={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100,latestWkid:3857}};let o=null;if(g(e)){const{bounds:r}=e;if(r){const e=p({x:r[0],y:r[1],spatialReference:t(f)}),s=p({x:r[2],y:r[3],spatialReference:t(f)});o={xmin:e.x,ymin:e.y,xmax:s.x,ymax:s.y,spatialReference:t(m)}}}null===o&&(o=r);const s=new x(y.create({spatialReference:S.WebMercator,size:512,numLODs:25})),l=512;let n=78271.51696400007,i=295828763.7957775;const u=[],a=e.hasOwnProperty("minzoom")&&null!=e.minzoom,c=e.hasOwnProperty("maxzoom")&&null!=e.maxzoom,d=a?+e.minzoom:0,w=c?+e.maxzoom:22;let h=0;a&&d>0&&d<25&&(h=s.getLODInfoAt(d).scale);let j=0;c&&w>0&&w<25&&(j=s.getLODInfoAt(w).scale);for(let t=0;t<=w;t++)u.push({level:t,scale:i,resolution:n}),n/=2,i/=2;return{capabilities:"TilesOnly",initialExtent:o,fullExtent:r,minScale:h,maxScale:j,tiles:e.tiles,tileInfo:{rows:l,cols:l,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:u,spatialReference:t(m)}}}export{w as loadMetadata};
